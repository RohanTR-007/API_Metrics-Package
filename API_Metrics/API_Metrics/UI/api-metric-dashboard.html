<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>API Metrics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --bg-card: #020817;
      --bg-card-soft: #020c1b;
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.08);
      --danger: #f97373;
      --danger-soft: rgba(248,113,113,0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #0b1120 0, #020617 55%);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    .shell {
      max-width: 1120px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem 2.5rem;
    }

    .page-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
      gap: .75rem;
      margin-bottom: 1.25rem;
    }

    .title {
      font-size: 1.4rem;
      font-weight: 650;
      letter-spacing: .03em;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .title-pill {
      font-size: .75rem;
      border-radius: 999px;
      padding: 0.1rem .55rem;
      border: 1px solid var(--border-subtle);
      background: rgba(15,23,42,.8);
      color: var(--text-muted);
    }

    .subtitle {
      font-size: .8rem;
      color: var(--text-muted);
    }

    .pill {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      border-radius: 999px;
      padding: .25rem .6rem;
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: .35rem;
    }

    .pill-dot {
      width: .4rem;
      height: .4rem;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,.15);
    }

    .grid {
      display: grid;
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .grid-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .card {
      border-radius: 1rem;
      border: 1px solid var(--border-subtle);
      background: linear-gradient(145deg, var(--bg-card) 0, var(--bg-card-soft) 80%);
      box-shadow:
        0 18px 45px rgba(15,23,42,.65),
        0 0 0 1px rgba(15,23,42,.9);
      padding: 1rem 1rem 1.1rem;
      position: relative;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      margin-bottom: .3rem;
    }

    .card-title {
      font-size: .8rem;
      font-weight: 600;
      color: var(--text-main);
      letter-spacing: .04em;
      text-transform: uppercase;
    }

    .metric-label {
      font-size: .72rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .12em;
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: 600;
      margin-top: .25rem;
    }

    .metric-secondary {
      font-size: .75rem;
      color: var(--text-muted);
      margin-top: .15rem;
    }

    .metric-accent {
      color: var(--accent);
    }

    .metric-danger {
      color: var(--danger);
    }

    .sparkle {
      position: absolute;
      inset: auto -40%;
      height: 3px;
      background: radial-gradient(circle at 0, rgba(56,189,248,.0) 0, rgba(56,189,248,.6) 20%, rgba(56,189,248,0) 60%);
      opacity: .7;
      pointer-events: none;
      transform: translateY(-4px);
    }

    .chart-wrapper {
      height: 260px;
    }

    .muted {
      color: var(--text-muted);
      font-size: .75rem;
    }

    .errors-list {
      display: flex;
      flex-direction: column;
      gap: .4rem;
      max-height: 260px;
      overflow: auto;
      padding-right: .25rem;
    }

    .error-item {
      border-radius: .75rem;
      border: 1px solid rgba(248,113,113,.22);
      background: radial-gradient(circle at 0 0, var(--danger-soft) 0, transparent 55%);
      padding: .55rem .6rem .45rem;
      font-size: .78rem;
    }

    .error-header {
      display: flex;
      justify-content: space-between;
      gap: .5rem;
      margin-bottom: .15rem;
    }

    .error-meta {
      font-size: .7rem;
      color: var(--text-muted);
    }

    .error-endpoint {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .72rem;
      color: #fca5a5;
      word-break: break-all;
    }

    .error-message {
      color: #fecaca;
      font-size: .76rem;
      margin-top: .1rem;
    }

    .error-toggle {
      border: none;
      background: transparent;
      color: var(--accent);
      font-size: .7rem;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
      text-underline-offset: 2px;
      white-space: nowrap;
    }

    .stacktrace {
      margin-top: .35rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .7rem;
      white-space: pre-wrap;
      background: rgba(15,23,42,.9);
      border-radius: .5rem;
      padding: .4rem .45rem;
      border: 1px solid rgba(15,23,42,.9);
      color: #e5e7eb;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.5);
      padding: .15rem .45rem;
      font-size: .68rem;
      color: var(--text-muted);
    }

    .badge-dot {
      width: .35rem;
      height: .35rem;
      border-radius: 999px;
      background: var(--danger);
    }

    .footer-text {
      margin-top: 1.4rem;
      font-size: .68rem;
      color: var(--text-muted);
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      align-items: center;
      opacity: .75;
    }

    .small-link {
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px dotted rgba(56,189,248,.5);
      padding-bottom: 1px;
      font-size: .68rem;
    }

    .small-link:hover {
      border-bottom-style: solid;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: .25rem;
    }

    .chip {
      border-radius: 999px;
      padding: .1rem .45rem;
      background: rgba(15,23,42,.85);
      border: 1px solid rgba(31,41,55,.85);
      font-size: .68rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <main class="shell">
    <header class="page-header">
      <div>
        <div class="title">
          API Metrics
          <span class="title-pill">embedded dashboard</span>
        </div>
        <div class="subtitle">
          Live view of request volume, status codes and failures across your ASP.NET Core API.
        </div>
      </div>
      <div class="chips">
        <div class="pill">
          <span class="pill-dot"></span>
          Live polling
        </div>
        <div class="chip">Auto-refresh: <span id="refresh-interval-label">5s</span></div>
      </div>
    </header>

    <section class="grid grid-3" style="margin-bottom:1.1rem;">
      <article class="card">
        <div class="sparkle"></div>
        <div class="metric-label">Total Requests</div>
        <div id="totalRequests" class="metric-value">0</div>
        <div class="metric-secondary">Across all endpoints since app start.</div>
      </article>
      <article class="card">
        <div class="metric-label">Success</div>
        <div id="totalSuccess" class="metric-value metric-accent">0</div>
        <div class="metric-secondary">
          <span id="successRate" class="metric-accent">0%</span> success rate
        </div>
      </article>
      <article class="card">
        <div class="metric-label">Failures</div>
        <div id="totalFailed" class="metric-value metric-danger">0</div>
        <div class="metric-secondary">
          <span id="failureRate" class="metric-danger">0%</span> error rate
        </div>
      </article>
    </section>

    <section class="grid grid-2">
      <article class="card">
        <div class="card-header">
          <div class="card-title">Requests per Endpoint</div>
          <span class="muted" id="endpoint-count-label">0 endpoints</span>
        </div>
        <div class="chart-wrapper">
          <canvas id="endpointChart"></canvas>
        </div>
      </article>

      <article class="card">
        <div class="card-header">
          <div class="card-title">Status Codes (All Endpoints)</div>
          <span class="muted">2xx / 4xx / 5xx distribution</span>
        </div>
        <div class="chart-wrapper">
          <canvas id="statusCodeChart"></canvas>
        </div>
      </article>
    </section>

    <section class="grid grid-2" style="margin-top:1rem;">
      <article class="card">
        <div class="card-header">
          <div class="card-title">Recent Failures</div>
          <span class="badge">
            <span class="badge-dot"></span>
            last few per endpoint
          </span>
        </div>
        <div id="errorsContainer" class="errors-list">
          <div class="muted">No failures recorded yet. ðŸ§ª Cause an error in an API to see it appear here.</div>
        </div>
      </article>

      <article class="card">
        <div class="card-header">
          <div class="card-title">Notes</div>
        </div>
        <p class="muted" style="margin-top:.25rem;">
          This embedded dashboard is powered entirely by in-memory metrics from the middleware inside your application process.
          It is intended for quick diagnostics and local or internal environments.
        </p>
        <p class="muted" style="margin-top:.4rem;">
          For long-term storage, alerting &amp; SLA tracking, wire the same data into a time-series backend such as Prometheus
          and visualize over time.
        </p>
        <p class="muted" style="margin-top:.6rem;">
          Sensitive values in query strings and headers are masked according to the configuration in <code>ApiStatsOptions</code>
          to avoid leaking secrets into diagnostics views.
        </p>
        <div class="footer-text">
          <span>Endpoints excluded from metrics can be configured per application.</span>
        </div>
      </article>
    </section>
  </main>

  <script>
    let endpointChart;
    let statusCodeChart;
    const REFRESH_INTERVAL_MS = 5000;

    async function fetchData() {
      try {
        const res = await fetch('/apiMetricDashboard-data', { cache: 'no-cache' });
        if (!res.ok) {
          console.error('Failed to load metrics:', res.status);
          return;
        }
        const data = await res.json();
        updateDashboard(data);
      } catch (err) {
        console.error('Error loading metrics:', err);
      }
    }

    function updateDashboard(data) {
      const total = data.totalRequests || 0;
      const success = data.totalSuccess || 0;
      const failed = data.totalFailed || 0;

      const totalEl = document.getElementById('totalRequests');
      const successEl = document.getElementById('totalSuccess');
      const failedEl = document.getElementById('totalFailed');
      const successRateEl = document.getElementById('successRate');
      const failureRateEl = document.getElementById('failureRate');

      totalEl.textContent = total;
      successEl.textContent = success;
      failedEl.textContent = failed;

      let successRate = 0;
      let failureRate = 0;
      if (total > 0) {
        successRate = (success / total) * 100;
        failureRate = (failed / total) * 100;
      }
      successRateEl.textContent = successRate.toFixed(1) + '%';
      failureRateEl.textContent = failureRate.toFixed(1) + '%';

      // Endpoint chart
      const endpoints = data.endpoints || [];
      const endpointLabels = endpoints.map(e => e.endpoint);
      const endpointCounts = endpoints.map(e => e.totalRequests);

      document.getElementById('endpoint-count-label').textContent =
        `${endpoints.length} endpoint${endpoints.length === 1 ? '' : 's'}`;

      const endpointCtx = document.getElementById('endpointChart').getContext('2d');
      if (!endpointChart) {
        endpointChart = new Chart(endpointCtx, {
          type: 'bar',
          data: {
            labels: endpointLabels,
            datasets: [{
              label: 'Requests',
              data: endpointCounts,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: {
                ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 0 },
                grid: { display: false }
              },
              y: {
                ticks: { color: '#9ca3af' },
                grid: { color: 'rgba(31,41,55,.6)' }
              }
            }
          }
        });
      } else {
        endpointChart.data.labels = endpointLabels;
        endpointChart.data.datasets[0].data = endpointCounts;
        endpointChart.update();
      }

      // Status code chart
      const statusMap = {};
      endpoints.forEach(e => {
        if (!e.statusCodeCounts) return;
        for (const code in e.statusCodeCounts) {
          statusMap[code] = (statusMap[code] || 0) + e.statusCodeCounts[code];
        }
      });

      const statusLabels = Object.keys(statusMap);
      const statusCounts = Object.values(statusMap);

      const statusCtx = document.getElementById('statusCodeChart').getContext('2d');
      if (!statusCodeChart) {
        statusCodeChart = new Chart(statusCtx, {
          type: 'doughnut',
          data: {
            labels: statusLabels,
            datasets: [{
              data: statusCounts,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: '#e5e7eb', boxWidth: 12 }
              }
            },
            cutout: '55%'
          }
        });
      } else {
        statusCodeChart.data.labels = statusLabels;
        statusCodeChart.data.datasets[0].data = statusCounts;
        statusCodeChart.update();
      }

      // Recent errors
      const errorsContainer = document.getElementById('errorsContainer');
      errorsContainer.innerHTML = '';

      const allErrors = [];
      endpoints.forEach(e => {
        (e.recentErrors || []).forEach(err => {
          allErrors.push({
            endpoint: e.endpoint,
            ...err
          });
        });
      });

      if (allErrors.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'No failures recorded yet. ðŸ§ª Cause an error in an API to see it appear here.';
        errorsContainer.appendChild(empty);
        return;
      }

      // Newest first
      allErrors.sort((a, b) => new Date(b.utcTime) - new Date(a.utcTime));

      allErrors.slice(0, 40).forEach(err => {
        const item = document.createElement('div');
        item.className = 'error-item';

        const header = document.createElement('div');
        header.className = 'error-header';

        const left = document.createElement('div');
        const time = new Date(err.utcTime);
        const timeLabel = time.toISOString().replace('T', ' ').replace('Z', ' UTC');

        left.innerHTML = `
          <div class="error-meta">${timeLabel}</div>
          <div class="error-endpoint">${err.method || '???'} ${err.endpoint}</div>
        `;

        const right = document.createElement('div');
        const toggle = document.createElement('button');
        toggle.className = 'error-toggle';
        toggle.type = 'button';
        toggle.textContent = 'View stack trace';
        right.appendChild(toggle);

        header.appendChild(left);
        header.appendChild(right);

        const msg = document.createElement('div');
        msg.className = 'error-message';
        msg.textContent = err.message || '(no message)';

        const stack = document.createElement('pre');
        stack.className = 'stacktrace';
        stack.textContent = err.stackTrace || '(no stack trace)';
        stack.style.display = 'none';

        toggle.addEventListener('click', () => {
          const visible = stack.style.display !== 'none';
          stack.style.display = visible ? 'none' : 'block';
          toggle.textContent = visible ? 'View stack trace' : 'Hide stack trace';
        });

        item.appendChild(header);
        item.appendChild(msg);
        item.appendChild(stack);

        errorsContainer.appendChild(item);
      });
    }

    document.getElementById('refresh-interval-label').textContent = (REFRESH_INTERVAL_MS / 1000) + 's';

    fetchData();
    setInterval(fetchData, REFRESH_INTERVAL_MS);
  </script>
</body>
</html>
